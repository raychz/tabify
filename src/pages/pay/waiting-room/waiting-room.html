<ion-header>
  <ion-navbar hideBackButton>
    <ion-buttons left>
      <button ion-button icon-start
        [disabled]="ticketService.overallUsersProgress > userStatus.Waiting && ticketService.unclaimedItems.length === 0"
        (click)="backButtonAction()">
        <ion-icon name="arrow-back"></ion-icon>
        <ion-label *ngIf="platform.is('ios')">
          Back
        </ion-label>
      </button>
    </ion-buttons>
    <ion-title>Waiting Lobby</ion-title>
  </ion-navbar>
</ion-header>


<ion-content class='cards-bg' *ngIf="ticketService.firestoreTicketItems; else loading">
  <ng-container>

    <ion-card id='curUserCard' (click)="ticketService.toggleIsExpanded(ticketService.curUser)">
      <ion-card-content>
        <ion-row>
          <ion-item>
            <ion-avatar item-start>
              <img [src]="ticketService.curUser.photoUrl || '../../../../../assets/imgs/user-light.png'">
            </ion-avatar>
            <ion-label> {{ ticketService.curUser.name }} </ion-label>
            <ion-spinner class="ticket-spinner" name="bubbles" color="primary" item-end
              *ngIf="ticketService.curUser.status < userStatus.Confirmed"></ion-spinner>
            <ion-icon name="checkmark-circle-outline" item-end
              *ngIf="ticketService.curUser.status >= userStatus.Confirmed"></ion-icon>
            <ion-icon [name]="ticketService.getUserExpanded(ticketService.curUser) ? 'arrow-dropup' : 'arrow-dropdown'"
              item-end></ion-icon>
          </ion-item>
        </ion-row>

        <ion-list *ngIf="ticketService.getUserExpanded(ticketService.curUser)">
          <ion-row class="item-details" *ngFor="let item of ticketService.curUser.ticketItems">
            <ion-col class="col-item-name">
              <span text-wrap class="name-text">{{ ticketService.getTicketItemName(item.name) }}</span>
              <span *ngIf="item.quantity > 1" text-nowrap class="quantity-text">x{{ item.quantity }}</span>
            </ion-col>
            <ion-col col-auto class="col-item-total">
              <span class="my-share-text" *ngIf="item.users && item.users.length > 1">
                ${{ ticketService.findUserShareOfItem(item, this.auth.getUid()) / 100 | number: '1.2-2' }} /
              </span>
              <span class="total-text">
                ${{ item.price / 100 | number: '1.2-2' }}
              </span>
            </ion-col>
          </ion-row>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card id='allUsersCard' *ngIf="ticketService.users.length > 1">
      <ion-card-header class="card-header" id="tell-your-friends">
        Tell your friends to pick their food already!
        <ion-label id="your-party">
          Your Party:
        </ion-label>
      </ion-card-header>
      <ion-list>
        <ng-container *ngFor="let user of ticketService.users">
          <ng-container *ngIf="user.uid !== ticketService.curUser.uid">
            <ion-card-content>
              <ion-item (click)="ticketService.toggleIsExpanded(user)">
                <ion-avatar item-start>
                  <img [src]="user.photoUrl || '../../../../../assets/imgs/user-light.png'">
                </ion-avatar>
                <ion-label> {{ user.name }} </ion-label>
                <ion-spinner class="ticket-spinner" name="bubbles" color="primary" item-end *ngIf="user.status < userStatus.Confirmed">
                </ion-spinner>
                <ion-icon name="checkmark-circle-outline" item-end *ngIf="user.status >= userStatus.Confirmed">
                </ion-icon>
                <ion-icon [name]="ticketService.getUserExpanded(user) ? 'arrow-dropup' : 'arrow-dropdown'" item-end>
                </ion-icon>
              </ion-item>

              <ion-list *ngIf="ticketService.getUserExpanded(user)">
                <ion-row class="item-details" *ngFor="let item of user.ticketItems">
                  <ion-col class="col-item-name">
                    <span text-wrap class="name-text">{{ ticketService.getTicketItemName(item.name) }}</span>
                    <span *ngIf="item.quantity > 1" text-nowrap class="quantity-text">x{{ item.quantity }}</span>
                  </ion-col>
                  <ion-col col-auto class="col-item-total">
                    <span class="my-share-text" *ngIf="item.users && item.users.length > 1">
                      ${{ ticketService.findUserShareOfItem(item, user.uid) / 100 | number: '1.2-2' }} /
                    </span>
                    <span class="total-text">
                      ${{ item.price / 100 | number: '1.2-2' }}
                    </span>
                  </ion-col>
                </ion-row>
              </ion-list>
            </ion-card-content>
          </ng-container>
        </ng-container>
      </ion-list>
    </ion-card>

    <ion-card>
      <ion-card-header class="card-header">
        Shared Items:
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ng-container *ngFor="let item of ticketService.sharedItems">

            <ion-row class="item-details" nowrap>
              <ion-col class="col-item-name">
                <span text-wrap class="name-text">{{ ticketService.getTicketItemName(item.name) }}</span>
                <span *ngIf="item.quantity > 1" text-nowrap class="quantity-text">x{{ item.quantity }}</span>
              </ion-col>
              <ion-col col-auto class="col-item-total">
                <span class="my-share-text" *ngIf="
                              item.users && item.users.length > 1 && item.isItemOnMyTab
                            ">
                  ${{ ticketService.findUserShareOfItem(item, this.auth.getUid()) / 100 | number: '1.2-2' }} /
                </span>
                <span class="total-text">
                  ${{ item.price / 100 | number: '1.2-2' }}
                </span>
              </ion-col>
            </ion-row>
            <ion-row class="item-details">
              <ion-col class="col-payers">
                <ion-icon color="primary" class="payers-icon" *ngIf="item.users && item.users.length > 0" name="ios-{{
                              item.users && item.users.length > 1 ? 'people' : 'person'
                            }}"></ion-icon>
                <span class="payers-count" *ngIf="item.users && item.users.length > 1">
                  {{ item.users.length }}:
                </span>
                <span class="payers-description-text">
                  {{ item.payersDescription }}
                </span>
              </ion-col>
            </ion-row>
          </ng-container>
        </ion-list>
      </ion-card-content>

    </ion-card>

    <ion-card *ngIf="ticketService.unclaimedItems.length > 0">
      <ion-card-header class="card-header">
        ⚠️ Unclaimed Items <span id="go-back-text">Go back to claim</span>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-row class="item-details" *ngFor="let item of ticketService.unclaimedItems">
            <ion-col class="col-item-name">
              <span text-wrap class="name-text">{{ ticketService.getTicketItemName(item.name) }}</span>
              <span *ngIf="item.quantity > 1" text-nowrap class="quantity-text">x{{ item.quantity }}</span>
            </ion-col>
            <ion-col col-auto class="col-item-total">
              <span class="total-text">
                ${{ item.price / 100 | number: '1.2-2' }}
              </span>
            </ion-col>
          </ion-row>
        </ion-list>
      </ion-card-content>

    </ion-card>
  </ng-container>

  <ng-template #loading>
    <p class="muted">Loading Waiting Room...</p>
    <ion-spinner class="ticket-spinner" name="bubbles" color="primary"></ion-spinner>
  </ng-template>
</ion-content>

<ion-footer>
  <ng-container>
    <ion-label text-wrap color="light" class="confirm-text">
      {{ selectConfirmButton ? (checkConfirmedStatus() ? 'All users have confirmed! Moving on to payment...' : 'Waiting for everyone else. All items must be selected...') : 'Make sure all users have joined before confirming' }}
    </ion-label>
    <button ion-button block (click)="toggleConfirm()"
      [disabled]="ticketService.overallUsersProgress > userStatus.Waiting && ticketService.unclaimedItems.length === 0">
      {{ selectConfirmButton ? 'Cancel' : 'Confirm' }}
    </button>
  </ng-container>
</ion-footer>
