<ion-header>
  <ion-navbar hideBackButton>
    <ion-title>Status Page</ion-title>
  </ion-navbar>
</ion-header>

<ion-content class="cards-bg">
  <ng-container>

    <ion-label id='openingText'>
      {{ checkPaidStatus() ? 'Everyone has paid!' : 'Please wait for everyone to pay before leaving.' }}</ion-label>
    <ion-card id='curUserCard' (click)="ablyTicketService.ticket.usersMap.get(currentUserUid).isStatusPageExpanded = !ablyTicketService.ticket.usersMap.get().isStatusPageExpanded">
      <ion-card-content>
        <ion-row class="item-user">

          <ion-col col-auto class="user-picture">
            <ion-avatar class="avatar">
              <img [src]="ablyTicketService.ticket.usersMap.get(currentUserUid).user.userDetail.photo_url || '../../../../../assets/imgs/user-light.png'">
            </ion-avatar>
          </ion-col>

          <ion-col col-auto class="user-name">
            <ion-label> {{ ablyTicketService.ticket.usersMap.get(currentUserUid).user.userDetail.abbreviatedName }} </ion-label>
          </ion-col>

          <ion-col col-auto class="user-total">
            <ion-label>
              ${{ (ablyTicketService.ticket.usersMap.get(currentUserUid).total + ablyTicketService.ticket.usersMap.get(currentUserUid).tax) / 100 | number: '1.2-2' }}
            </ion-label>
          </ion-col>

          <ion-col col-auto class="ticket-spinner" *ngIf="ablyTicketService.ticket.usersMap.get(currentUserUid).status < TicketUserStatusOrder[TicketUserStatus.PAID]">
            <ion-spinner name="bubbles"></ion-spinner>
          </ion-col>

          <ion-col col-auto class="user-icons">
            <ion-icon class="icon" name="checkmark-circle-outline"
              *ngIf="ablyTicketService.ticket.usersMap.get(currentUserUid).status >= TicketUserStatusOrder[TicketUserStatus.PAID]">
            </ion-icon>
            <ion-icon class="icon"
              [name]="ablyTicketService.ticket.usersMap.get(currentUserUid).isStatusPageExpanded ? 'arrow-dropdown' : 'arrow-dropup'">
            </ion-icon>
          </ion-col>
        </ion-row>

        <ion-list *ngIf="ablyTicketService.ticket.usersMap.get(currentUserUid).isStatusPageExpanded">
          <ng-container *ngFor="let item of ablyTicketService.ticket.items">
            <ng-container *ngIf="item.usersMap.has(currentUserUid)">
              <ion-row class="item-details">
                <ion-col class="col-item-name">
                  <span text-wrap class="name-text">{{ item.name }}</span>
                  <span *ngIf="item.quantity > 1" text-nowrap class="quantity-text">x{{ item.quantity }}</span>
                </ion-col>
                <ion-col col-auto class="col-item-total">
                  <span class="my-share-text" *ngIf="item.users && item.users.length > 1">
                    ${{ item.usersMap.get(currentUserUid).price / 100 | number: '1.2-2' }} /
                  </span>
                  <span class="total-text">
                    ${{ item.price / 100 | number: '1.2-2' }}
                  </span>
                </ion-col>
              </ion-row>
              <ion-row class="item-details">
                <ion-col class="col-item-name">
                  <span class="name-text"> ðŸ’² Tax</span>
                </ion-col>
                <ion-col col-auto class="col-item-total">
                  <span class="total-text">
                    ${{ ablyTicketService.ticket.usersMap.get(currentUserUid).tax / 100 | number: '1.2-2' }}
                  </span>
                </ion-col>
              </ion-row>
            </ng-container>
          </ng-container>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <ion-card id='allUsersCard' *ngIf="ablyTicketService.ticket.users.length > 1">
      <ion-card-header class="card-header" id="tell-your-friends">
        <ion-label id="your-party">
          Your Party:
        </ion-label>
      </ion-card-header>
      <ion-list>
        <ng-container *ngFor="let ticketUser of ablyTicketService.ticket.users">
            <ion-card-content *ngIf="ticketUser.user.uid !== currentUserUid">
              <ion-row class="item-user" (click)="ticketUser.isStatusPageExpanded = !ticketUser.isStatusPageExpanded">
                <ion-col class="user-picture">
                  <ion-item>
                    <ion-avatar item-start>
                      <img [src]="ticketUser.user.userDetail.photo_url || '../../../../../assets/imgs/user-light.png'">
                    </ion-avatar>
                    {{ ticketUser.user.userDetail.abbreviatedName }}
                  </ion-item>
                </ion-col>

                <ion-col class="user-total">
                  <ion-label>
                    ${{ (ticketUser.total + ticketUser.tax) / 100 | number: '1.2-2' }}
                  </ion-label>
                </ion-col>

                <ion-col class="user-icons">
                  <ion-item>
                    <ion-badge item-end class="status-badge" color="warning"
                      *ngIf="TicketUserStatusOrder[ticketUser.status] <= TicketUserStatusOrder[TicketUserStatus.PAYING]">
                      PAYING</ion-badge>
                    <ion-badge item-end class="status-badge" color="secondary"
                      *ngIf="TicketUserStatusOrder[ticketUser.status] >= TicketUserStatusOrder[TicketUserStatus.PAID]">
                      PAID</ion-badge>
                    <ion-icon [name]="ticketUser.isStatusPageExpanded ? 'ios-arrow-up' : 'ios-arrow-down'" item-end>
                    </ion-icon>
                  </ion-item>
                </ion-col>
              </ion-row>

              <ion-list *ngIf="ticketUser.isStatusPageExpanded">
                <ng-container *ngFor="let item of ablyTicketService.ticket.items">
                  <ng-container *ngIf="item.usersMap.has(ticketUser.user.uid)">
                    <ion-row class="item-details">
                      <ion-col class="col-item-name">
                        <span text-wrap class="name-text">{{ item.name }}</span>
                        <span *ngIf="item.quantity > 1" text-nowrap class="quantity-text">x{{ item.quantity }}</span>
                      </ion-col>
                      <ion-col col-auto class="col-item-total">
                        <span class="my-share-text" *ngIf="item.users && item.users.length > 1">
                          ${{ item.usersMap.get(ticketUser.user.uid).price / 100 | number: '1.2-2' }} /
                        </span>
                        <span class="total-text">
                          ${{ item.price / 100 | number: '1.2-2' }}
                        </span>
                      </ion-col>
                    </ion-row>
                    <ion-row class="item-details">
                      <ion-col class="col-item-name">
                        <span class="name-text"> ðŸ’² Tax</span>
                      </ion-col>
                      <ion-col col-auto class="col-item-total">
                        <span class="total-text">
                          ${{ ablyTicketService.ticket.usersMap.get(ticketUser.user.uid).tax / 100 | number: '1.2-2' }}
                        </span>
                      </ion-col>
                    </ion-row>
                  </ng-container>
                </ng-container>
              </ion-list>
            </ion-card-content>
        </ng-container>
      </ion-list>
    </ion-card>

  </ng-container>
</ion-content>

<ion-footer>
  <ng-container>
    <ion-card>
      <ion-row id="total-bill-row">
        <ion-col>
          Your Party Owes:
        </ion-col>
        <ion-col col-auto>
          <span id="amount-owed">
            ${{ ablyTicketService.ticket.ticketTotal.due / 100 | number: '1.2-2' }} /
          </span>
          <span id="total-bill">
            ${{ ablyTicketService.ticket.ticketTotal.total / 100 | number: '1.2-2' }}
          </span>
        </ion-col>
      </ion-row>
    </ion-card>
  </ng-container>
</ion-footer>
